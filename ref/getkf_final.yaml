_member: &memberConfig
  date: &analysisDate '2024050600'
  state variables:
  - water_vapor_mixing_ratio_wrt_moist_air
  - air_pressure_at_surface
  - air_temperature
  - northward_wind
  - eastward_wind
  - air_potential_temperature
  - dry_air_density
  - u
  - water_vapor_mixing_ratio_wrt_dry_air
  - air_pressure
  - landmask
  - seaice_fraction
  - snowc
  - skin_temperature_at_surface
  - ivgtyp
  - isltyp
  - snowh
  - vegetation_area_fraction
  - eastward_wind_at_10m
  - northward_wind_at_10m
  - lai
  - smois
  - tslb
  - pressure_p
  - cloud_liquid_water
  - cloud_liquid_ice
  - graupel
  - rain_water
  - snow_water
  - cldfrac
  stream name: background

increment variables: [air_temperature, water_vapor_mixing_ratio_wrt_moist_air, eastward_wind, northward_wind, air_pressure_at_surface]

output mean prior:
  filename: ./prior_mean.nc
  stream name: background

output: # for outputting mean posterior
  filename: ./data/ana/mem%{member}%.nc
  stream name: analysis

time window:
  begin: '2024050600'
  length: PT4H

geometry:
  nml_file: ./namelist.atmosphere
  streams_file: ./streams.atmosphere
  deallocate non-da fields: true
  interpolation type: unstructured
  iterator dimension: 2

background:
  members from template:
    template:
      <<: *memberConfig
      filename: ./data/ens/mem%iMember%.nc
    pattern: "%iMember%"
    start: 1
    zero padding: 3
    nmembers: 30

driver:
  run as observer only: true
  update obs config with geometry info: false

local ensemble DA:
  solver: Deterministic GETKF
  use linear observer: true
  vertical localization: # current settings use 12 modulated members
    fraction of retained variance: 0.850
    lengthscale: 0.50
    lengthscale units: logp
  inflation:
    rtps: 0.95

observations:
     observers:
     - obs space:
         name: adpupa_t120
         distribution:
           name: "RoundRobin"
           halo size: 500e3
         obsdatain:
           engine:
             type: H5File
             obsfile: data/obs/ioda_adpupa.nc
             missing file action: "warn"
           obsgrouping:
             group variables: ["stationIdentification"]
             sort variable: "pressure"
             sort order: "descending"
         obsdataout:
           engine:
             type: H5File
             obsfile: jdiag_adpupa_t120.nc
             allow overwrite: true
         io pool:
           max pool size: 1
         observed variables: [airTemperature]
         simulated variables: [airTemperature]

       obs operator:
           name: VertInterp
           vertical coordinate: air_pressure
           observation vertical coordinate: pressure
           observation vertical coordinate group: MetaData
           interpolation method: log-linear
           #gsi geovals:
           #  filename: "obsout/sondes_tsen_geoval_2022052619.nc4"
           #  levels_are_top_down: False
           variables:
           - name: airTemperature

       linear obs operator:
         name: VertInterp

       obs error:
         covariance model: diagonal

       obs localizations:
         - localization method: Horizontal Gaspari-Cohn
           lengthscale: 200e3 # orig

       obs filters:
         # ------------------
         # airTemperature (120)
         # ------------------
         # Reject all obs with QualityMarker > 3
         - filter: RejectList
           apply at iterations: 0,1
           filter variables:
           - name: airTemperature
           where:
           - variable: QualityMarker/airTemperature
             is_in: 4-15
             value: is_not_valid
           where operator: or
           action:
             name: reduce obs space

         # Time window filter
         - filter: Domain Check
           apply at iterations: 0,1
           where:
             - variable:
                 name: MetaData/timeOffset # units: s
               minvalue: -5400
               maxvalue:  5400
           action:
             name: reduce obs space

         # Duplicate Check
#         - filter: Temporal Thinning
#           apply at iterations: 0,1
#           filter variables:
#           - name: airTemperature
#           min_spacing: PT90M
#           tolerance: PT0H
#           seed_time: "2024050600"
#           category_variable:
#             name: MetaData/longitude_latitude_pressure
#           action:
#             name: reduce obs space

         # Online regional domain check
         - filter: Bounds Check
           filter variables:
           - name: airTemperature
           test variables:
           - name:  GeoVaLs/observable_domain_mask
           minvalue: 0.0
           maxvalue: 0.5

         # Initial error assignment
         - filter: Perform Action
           filter variables:
           - name: airTemperature
           where:
           - variable: ObsType/airTemperature
             is_in: 120
           action:
             name: assign error
             error function:
               name: ObsFunction/ObsErrorModelStepwiseLinear
               options:
                 xvar:
                   name: MetaData/pressure
                 xvals: [110000, 105000, 100000, 95000, 90000, 85000, 80000, 75000, 70000, 65000, 60000, 55000, 50000, 45000, 40000, 35000, 30000, 25000, 20000, 15000, 10000, 7500, 5000, 4000, 3000, 2000, 1000, 500, 400, 300, 200, 100, 0]
                 errors: [1.2671, 1.3302, 1.4017, 1.4543, 1.4553, 1.3865, 1.2696, 1.1458, 1.0461, 0.98493, 0.95259, 0.9353, 0.92541, 0.92565, 0.94536, 0.99513, 1.0799, 1.1885, 1.2894, 1.3559, 1.3854, 1.3857, 1.3525, 1.3019, 1.2818, 1.3112, 1.3698, 1.4263, 1.4654, 1.4868, 1.4964, 1.4992, 1.4962]

         # Error inflation based on pressure check (setupt.f90)
         - filter: Perform Action
           filter variables:
           - name: airTemperature
           where:
           - variable: ObsType/airTemperature
             is_in: 120
           action:
             name: inflate error
             inflation variable:
               name: ObsFunction/ObsErrorFactorPressureCheck
               options:
                 variable: airTemperature
                 inflation factor: 8.0

         # Error inflation based on errormod (qcmod.f90)
         - filter: Perform Action
           filter variables:
           - name: airTemperature
           where:
           - variable: ObsType/airTemperature
             is_in: 120
           action:
             name: inflate error
             inflation variable:
               name: ObsFunction/ObsErrorFactorConventional
               options:
                 inflate variables: [airTemperature]
                 pressure: MetaData/pressure

         # Error inflation when QualityMarker == 3 (read_prepbufr.f90)
         - filter: Perform Action
           filter variables:
           - name: airTemperature
           action:
             name: inflate error
             inflation factor: 1.2
           where:
           - variable: QualityMarker/airTemperature
             is_in: 3

         # Error inflation when observation pressure < 100 hPa (read_prepbufr.f90)
         - filter: Perform Action
           filter variables:
           - name: airTemperature
           action:
             name: inflate error
             inflation factor: 1.2
           where:
           - variable: MetaData/pressure
             maxvalue: 10000.0

         # Bounds Check (ObsError)
         - filter: Bounds Check
           filter variables:
           - name: airTemperature
           test variables:
           - name:  ObsErrorData/airTemperature
           minvalue: 0.0
           action:
             name: reduce obs space

         # Bounds Check (ObsValue)
         - filter: Bounds Check
           filter variables:
           - name: airTemperature
           minvalue: 100
           maxvalue: 400
           action:
             name: reduce obs space

         # Create temporary ObsErrorData
         - filter: Variable Assignment
           apply at iterations: 0,1
           assignments:
           - name: TempObsErrorData/airTemperature
             type: float
             function:
               name: ObsFunction/Arithmetic
               options:
                 variables:
                 - name: ObsErrorData/airTemperature
           defer to post: true

         # Set ObsError set "error parameter" if < "max value"
         - filter: Perform Action
           apply at iterations: 0,1
           filter variables:
           - name: airTemperature
           action:
             name: assign error
             error parameter: 1.3
           where:
           - variable:
               name: ObsErrorData/airTemperature
             maxvalue: 1.3
           - variable:
               name: ObsErrorData/airTemperature
             value: is_valid
           defer to post: true

         # Set ObsError set "error parameter" if > "min value"
         - filter: Perform Action
           apply at iterations: 0,1
           filter variables:
           - name: airTemperature
           action:
             name: assign error
             error parameter: 5.6
           where:
           - variable:
               name: ObsErrorData/airTemperature
             minvalue: 5.6
           - variable:
               name: ObsErrorData/airTemperature
             value: is_valid
           defer to post: true

         # Gross Error Check
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: airTemperature
           threshold: 7.0
           action:
             name: reject
           where:
           - variable: ObsType/airTemperature
           - variable: QualityMarker/airTemperature
             is_not_in: 3
           defer to post: true

         # Gross Error Check: cgross*0.7 if QualityMarker=3
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: airTemperature
           threshold: 4.9
           action:
             name: reject
           where:
           - variable: ObsType/airTemperature
           - variable: QualityMarker/airTemperature
             is_in: 3
           defer to post: true

         # Re-assign err ObsErrorData <--- TempObsErrorData after gross error check.
         - filter: Perform Action
           apply at iterations: 0,1
           filter variables:
           - name: airTemperature
           action:
             name: assign error
             error function: TempObsErrorData/airTemperature
           where:
           - variable:
               name: TempObsErrorData/airTemperature
             value: is_valid
           defer to post: true

         #- filter: GOMsaver
         #  filename: ./data/geovals/adpupa_geovals_rrfs.nc4
     - obs space:
         name: adpupa_q120
         distribution:
           name: "RoundRobin"
           halo size: 500e3
         obsdatain:
           engine:
             type: H5File
             obsfile: data/obs/ioda_adpupa.nc
             missing file action: "warn"
           obsgrouping:
             group variables: ["stationIdentification"]
             sort variable: "pressure"
             sort order: "descending"
         obsdataout:
           engine:
             type: H5File
             obsfile: jdiag_adpupa_q120.nc
             allow overwrite: true
         io pool:
           max pool size: 1
         observed variables: [specificHumidity]
         simulated variables: [specificHumidity]

       obs operator:
           name: VertInterp
           vertical coordinate: air_pressure
           observation vertical coordinate: pressure
           observation vertical coordinate group: MetaData
           interpolation method: log-linear
           #gsi geovals:
           #  filename: "obsout/sondes_q_geoval_2022052619.nc4"
           #  levels_are_top_down: False
           variables:
           - name: specificHumidity

       linear obs operator:
         name: VertInterp

       obs error:
         covariance model: diagonal

       obs localizations:
         - localization method: Horizontal Gaspari-Cohn
           lengthscale: 200e3 # orig

       obs filters:
         - filter: Perform Action
           action:
             name: passivate

         # ------------------
         # specificHumidity (120)
         # ------------------
         # Reject all obs with QualityMarker > 3
         - filter: RejectList
           apply at iterations: 0,1
           filter variables:
           - name: specificHumidity
           where:
           - variable: QualityMarker/specificHumidity
             is_in: 4-15
             value: is_not_valid
           where operator: or
           action:
             name: reduce obs space

         # Time window filter
         - filter: Domain Check
           apply at iterations: 0,1
           where:
             - variable:
                 name: MetaData/timeOffset # units: s
               minvalue: -5400
               maxvalue:  5400
           action:
             name: reduce obs space

         # Duplicate Check
#         - filter: Temporal Thinning
#           apply at iterations: 0,1
#           filter variables:
#           - name: specificHumidity
#           min_spacing: PT90M
#           tolerance: PT0H
#           seed_time: "2024050600"
#           category_variable:
#             name: MetaData/longitude_latitude_pressure
#           action:
#             name: reduce obs space

         # Online regional domain check
         - filter: Bounds Check
           filter variables:
           - name: specificHumidity
           test variables:
           - name:  GeoVaLs/observable_domain_mask
           minvalue: 0.0
           maxvalue: 0.5

         # Initial error assignment
         - filter: Perform Action
           filter variables:
           - name: specificHumidity
           where:
           - variable: ObsType/specificHumidity
             is_in: 120
           action:
             name: assign error
             error function:
               name: ObsFunction/ObsErrorModelStepwiseLinear
               options:
                 xvar:
                   name: MetaData/pressure
                 xvals: [110000, 105000, 100000, 95000, 90000, 85000, 80000, 75000, 70000, 65000, 60000, 55000, 50000, 45000, 40000, 35000, 30000, 25000, 20000, 15000, 10000, 7500, 5000, 4000, 3000, 2000, 1000, 500, 400, 300, 200, 100, 0]
                 errors: [0.056103, 0.063026, 0.073388, 0.086305, 0.099672, 0.1121, 0.12347, 0.13337, 0.14214, 0.15031, 0.15641, 0.1594, 0.15962, 0.16026, 0.16419, 0.17154, 0.1798, 0.18754, 0.19339, 0.19701, 0.19887, 0.19966, 0.19993, 0.2, 0.2, 0.2, 0.19999, 0.19999, 0.19999, 0.20001, 0.20004, 0.19999, 0.19949]

         # Error inflation based on pressure check (setupq.f90)
         - filter: Perform Action
           filter variables:
           - name: specificHumidity
           where:
           - variable: ObsType/specificHumidity
             is_in: 120
           action:
             name: inflate error
             inflation variable:
               name: ObsFunction/ObsErrorFactorPressureCheck
               options:
                 variable: specificHumidity
                 inflation factor: 8.0
                 request_saturation_specific_humidity_geovals: false

         # Error inflation based on errormod (qcmod.f90)
         - filter: Perform Action
           filter variables:
           - name: specificHumidity
           where:
           - variable: ObsType/specificHumidity
             is_in: 120
           action:
             name: inflate error
             inflation variable:
               name: ObsFunction/ObsErrorFactorConventional
               options:
                 inflate variables: [specificHumidity]
                 pressure: MetaData/pressure

         # Error inflation when QualityMarker == 3 (read_prepbufr.f90)
         - filter: Perform Action
           filter variables:
           - name: specificHumidity
           action:
             name: inflate error
             inflation factor: 1.2
           where:
           - variable: QualityMarker/specificHumidity
             is_in: 3

         # Error inflation when observation pressure < 100 hPa (read_prepbufr.f90)
         - filter: Perform Action
           filter variables:
           - name: specificHumidity
           action:
             name: inflate error
             inflation factor: 1.2
           where:
           - variable: MetaData/pressure
             maxvalue: 10000.0

         # Bounds Check (ObsError)
         - filter: Bounds Check
           filter variables:
           - name: specificHumidity
           test variables:
           - name:  ObsErrorData/specificHumidity
           minvalue: 0.0
           action:
             name: reduce obs space

         # Bounds Check (ObsValue)
         - filter: Bounds Check
           filter variables:
           - name: specificHumidity
           minvalue: 0.0
           maxvalue: 1.0
           action:
             name: reduce obs space

         # Create temporary ObsErrorData
         - filter: Variable Assignment
           apply at iterations: 0,1
           assignments:
           - name: TempObsErrorData/specificHumidity
             type: float
             function:
               name: ObsFunction/Arithmetic
               options:
                 variables:
                 - name: ObsErrorData/specificHumidity
           defer to post: true

         # Set ObsError set "error parameter" if < "max value"
         - filter: Perform Action
           apply at iterations: 0,1
           filter variables:
           - name: specificHumidity
           action:
             name: assign error
             error parameter: 5.0
           where:
           - variable:
               name: ObsErrorData/specificHumidity
             maxvalue: 5.0
           - variable:
               name: ObsErrorData/specificHumidity
             value: is_valid
           defer to post: true

         # Set ObsError set "error parameter" if > "min value"
         - filter: Perform Action
           apply at iterations: 0,1
           filter variables:
           - name: specificHumidity
           action:
             name: assign error
             error parameter: 50.0
           where:
           - variable:
               name: ObsErrorData/specificHumidity
             minvalue: 50.0
           - variable:
               name: ObsErrorData/specificHumidity
             value: is_valid
           defer to post: true

         # Gross Error Check
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: specificHumidity
           threshold: 7.0
           action:
             name: reject
           where:
           - variable: ObsType/specificHumidity
           - variable: QualityMarker/specificHumidity
             is_not_in: 3
           defer to post: true

         # Gross Error Check: cgross*0.7 if QualityMarker=3
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: specificHumidity
           threshold: 4.9
           action:
             name: reject
           where:
           - variable: ObsType/specificHumidity
           - variable: QualityMarker/specificHumidity
             is_in: 3
           defer to post: true

         # Re-assign err ObsErrorData <--- TempObsErrorData after gross error check.
         - filter: Perform Action
           apply at iterations: 0,1
           filter variables:
           - name: specificHumidity
           action:
             name: assign error
             error function: TempObsErrorData/specificHumidity
           where:
           - variable:
               name: TempObsErrorData/specificHumidity
             value: is_valid
           defer to post: true

         #- filter: GOMsaver
         #  filename: ./data/geovals/adpupa_geovals_rrfs.nc4
     - obs space:
         name: adpupa_uv220
         distribution:
           name: "RoundRobin"
           halo size: 500e3
         obsdatain:
           engine:
             type: H5File
             obsfile: data/obs/ioda_adpupa.nc
             missing file action: "warn"
           obsgrouping:
             group variables: ["stationIdentification"]
             sort variable: "pressure"
             sort order: "descending"
         obsdataout:
           engine:
             type: H5File
             obsfile: jdiag_adpupa_uv220.nc
             allow overwrite: true
         io pool:
           max pool size: 1
         observed variables: [windEastward, windNorthward]
         simulated variables: [windEastward, windNorthward]

       obs operator:
           name: VertInterp
           vertical coordinate: air_pressure
           observation vertical coordinate: pressure
           observation vertical coordinate group: MetaData
           interpolation method: log-linear
           #gsi geovals:
           #  filename: "obsout/sondes_uv_geoval_2022052619.nc4"
           #  levels_are_top_down: False
           variables:
           - name: windEastward
           - name: windNorthward

       linear obs operator:
         name: VertInterp

       obs error:
         covariance model: diagonal

       obs localizations:
         - localization method: Horizontal Gaspari-Cohn
           lengthscale: 200e3 # orig

       obs filters:
         # ------------------
         # wind (220)
         # ------------------
         # Reject all obs with QualityMarker > 3
         - filter: RejectList
           apply at iterations: 0,1
           filter variables:
           - name: windEastward
           - name: windNorthward
           where:
           - variable: QualityMarker/windEastward
             is_in: 4-15
             value: is_not_valid
           where operator: or
           action:
             name: reduce obs space

         # Time window filter
         - filter: Domain Check
           apply at iterations: 0,1
           where:
             - variable:
                 name: MetaData/timeOffset # units: s
               minvalue: -5400
               maxvalue:  5400
           action:
             name: reduce obs space

         # Duplicate Check
#         - filter: Temporal Thinning
#           apply at iterations: 0,1
#           filter variables:
#           - name: windEastward
#           - name: windNorthward
#           min_spacing: PT90M
#           tolerance: PT0H
#           seed_time: "2024050600"
#           category_variable:
#             name: MetaData/longitude_latitude_pressure
#           action:
#             name: reduce obs space

         # Online domain check
         - filter: Bounds Check
           filter variables:
           - name: windEastward
           - name: windNorthward
           test variables:
           - name:  GeoVaLs/observable_domain_mask
           minvalue: 0.0
           maxvalue: 0.5

         # Initial error assignment
         - filter: Perform Action
           filter variables:
           - name: windEastward
           - name: windNorthward
           where:
           - variable: ObsType/windEastward
             is_in: 220
           action:
             name: assign error
             error function:
               name: ObsFunction/ObsErrorModelStepwiseLinear
               options:
                 xvar:
                   name: MetaData/pressure
                 xvals: [110000, 105000, 100000, 95000, 90000, 85000, 80000, 75000, 70000, 65000, 60000, 55000, 50000, 45000, 40000, 35000, 30000, 25000, 20000, 15000, 10000, 7500, 5000, 4000, 3000, 2000, 1000, 500, 400, 300, 200, 100, 0]
                 errors: [1.7721, 2.0338, 2.2927, 2.4559, 2.5377, 2.5705, 2.5557, 2.5239, 2.4846, 2.4369, 2.4098, 2.433, 2.5005, 2.5682, 2.595, 2.602, 2.6262, 2.6879, 2.7566, 2.7674, 2.7115, 2.6363, 2.5409, 2.4103, 2.2838, 2.1916, 2.1381, 2.1126, 2.1029, 2.1003, 2.1002, 2.0998, 2.0946]

         # Error inflation (windEastward) based on pressure check (setupw.f90)
         - filter: Perform Action
           filter variables:
           - name: windEastward
           where:
           - variable: ObsType/windEastward
             is_in: 220
           action:
             name: inflate error
             inflation variable:
               name: ObsFunction/ObsErrorFactorPressureCheck
               options:
                 variable: windEastward
                 inflation factor: 4.0

         # Error inflation (windNorthward) based on pressure check (setupw.f90)
         - filter: Perform Action
           filter variables:
           - name: windNorthward
           where:
           - variable: ObsType/windNorthward
             is_in: 220
           action:
             name: inflate error
             inflation variable:
               name: ObsFunction/ObsErrorFactorPressureCheck
               options:
                 variable: windNorthward
                 inflation factor: 4.0

         # Error inflation (windEastward) based on errormod (qcmod.f90)
         - filter: Perform Action
           filter variables:
           - name: windEastward
           where:
           - variable: ObsType/windEastward
             is_in: 220
           action:
             name: inflate error
             inflation variable:
               name: ObsFunction/ObsErrorFactorConventional
               options:
                 inflate variables: [windEastward]
                 test QCflag: QualityMarker
                 test QCthreshold: 3
                 distance threshold: 0
                 pressure: MetaData/pressure

         # Error inflation (windNorthward) based on errormod (qcmod.f90)
         - filter: Perform Action
           filter variables:
           - name: windNorthward
           where:
           - variable: ObsType/windNorthward
             is_in: 220
           action:
             name: inflate error
             inflation variable:
               name: ObsFunction/ObsErrorFactorConventional
               options:
                 inflate variables: [windNorthward]
                 test QCflag: QualityMarker
                 test QCthreshold: 3
                 distance threshold: 0
                 pressure: MetaData/pressure

         # Error inflation when QualityMarker == 3 (read_prepbufr.f90)
         - filter: Perform Action
           filter variables:
           - name: windEastward
           - name: windNorthward
           action:
             name: inflate error
             inflation factor: 1.2
           where:
           - variable: QualityMarker/windEastward
             is_in: 3

         # Error inflation when observation pressure < 50 hPa (read_prepbufr.f90)
         - filter: Perform Action
           filter variables:
           - name: windEastward
           - name: windNorthward
           action:
             name: inflate error
             inflation factor: 1.2
           where:
           - variable: MetaData/pressure
             maxvalue: 5000.0

         # Bounds Check (ObsError)
         - filter: Bounds Check
           filter variables:
           - name: windEastward
           - name: windNorthward
           test variables:
           - name:  ObsErrorData/windEastward
           minvalue: 0.0
           action:
             name: reduce obs space

         # Bounds Check (ObsValue)
         - filter: Bounds Check
           filter variables:
           - name: windEastward
           - name: windNorthward
           minvalue: -200
           maxvalue: 200
           action:
             name: reduce obs space

         # Gross Error Check (windEastward)
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: windEastward
           function absolute threshold:
           - name: ObsFunction/WindsSPDBCheck
             options:
               wndtype:    [ 220 ]
               cgross:     [ 8.0 ]
               error_min:  [ 1.4 ]
               error_max:  [ 6.1 ]
               variable: windEastward
           where:
           - variable: QualityMarker/windEastward
             is_not_in: 3
           action:
             name: reject
           defer to post: true

         # Gross Error Check (windNorthward)
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: windNorthward
           function absolute threshold:
           - name: ObsFunction/WindsSPDBCheck
             options:
               wndtype:    [ 220 ]
               cgross:     [ 8.0 ]
               error_min:  [ 1.4 ]
               error_max:  [ 6.1 ]
               variable: windNorthward
           where:
           - variable: QualityMarker/windNorthward
             is_not_in: 3
           action:
             name: reject
           defer to post: true

         # Gross Error Check (windEastward): cgross*0.7 if QualityMarker=3
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: windEastward
           function absolute threshold:
           - name: ObsFunction/WindsSPDBCheck
             options:
               wndtype:    [ 220 ]
               cgross:     [ 5.6 ]
               error_min:  [ 1.4 ]
               error_max:  [ 6.1 ]
               variable: windEastward
           where:
           - variable: QualityMarker/windEastward
             is_in: 3
           action:
             name: reject
           defer to post: true

         # Gross Error Check (windNorthward): cgross*0.7 if QualityMarker=3
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: windNorthward
           function absolute threshold:
           - name: ObsFunction/WindsSPDBCheck
             options:
               wndtype:    [ 220 ]
               cgross:     [ 5.6 ]
               error_min:  [ 1.4 ]
               error_max:  [ 6.1 ]
               variable: windNorthward
           where:
           - variable: QualityMarker/windNorthward
             is_in: 3
           action:
             name: reject
           defer to post: true

         #- filter: GOMsaver
         #  filename: ./data/geovals/adpupa_geovals_rrfs.nc4
     - obs space:
         name: aircar_t133
         distribution:
           name: "RoundRobin"
           halo size: 500e3
         obsdatain:
           engine:
             type: H5File
             obsfile: data/obs/ioda_aircar.nc
             missing file action: "warn"
           obsgrouping:
             group variables: ["stationIdentification"]
             sort variable: "pressure"
             sort order: "descending"
         obsdataout:
           engine:
             type: H5File
             obsfile: jdiag_aircar_t133.nc
             allow overwrite: true
         io pool:
           max pool size: 1
         observed variables: [airTemperature]
         simulated variables: [airTemperature]

       obs operator:
           name: VertInterp
           vertical coordinate: air_pressure
           observation vertical coordinate: pressure
           observation vertical coordinate group: MetaData
           interpolation method: log-linear
           #gsi geovals:
           #  filename: "obsout/aircraft_tsen_geoval_2022052619.nc4"
           #  levels_are_top_down: False
           variables:
           - name: airTemperature

       linear obs operator:
         name: VertInterp

       obs error:
         covariance model: diagonal

       obs localizations:
         - localization method: Horizontal Gaspari-Cohn
           lengthscale: 200e3 # orig

       obs filters:
         # ------------------
         # airTemperature (133)
         # ------------------
         # Reject all obs with QualityMarker > 3
         - filter: RejectList
           apply at iterations: 0,1
           filter variables:
           - name: airTemperature
           where:
           - variable: QualityMarker/airTemperature
             is_in: 4-15
             value: is_not_valid
           where operator: or
           action:
             name: reduce obs space

         # Time window filter
         - filter: Domain Check
           apply at iterations: 0,1
           where:
             - variable:
                 name: MetaData/timeOffset # units: s
               minvalue: -5400
               maxvalue:  5400
           action:
             name: reduce obs space

         # Duplicate Check
#         - filter: Temporal Thinning
#           apply at iterations: 0,1
#           filter variables:
#           - name: airTemperature
#           min_spacing: PT90M
#           tolerance: PT0H
#           seed_time: "2024050600"
#           category_variable:
#             name: MetaData/longitude_latitude_pressure
#           action:
#             name: reduce obs space

         # Online regional domain check
         - filter: Bounds Check
           filter variables:
           - name: airTemperature
           test variables:
           - name:  GeoVaLs/observable_domain_mask
           minvalue: 0.0
           maxvalue: 0.5

         # Initial error assignment
         - filter: Perform Action
           filter variables:
           - name: airTemperature
           where:
           - variable: ObsType/airTemperature
             is_in: 133
           action:
             name: assign error
             error function:
               name: ObsFunction/ObsErrorModelStepwiseLinear
               options:
                 xvar:
                   name: MetaData/pressure
                 xvals: [110000, 105000, 100000, 95000, 90000, 85000, 80000, 75000, 70000, 65000, 60000, 55000, 50000, 45000, 40000, 35000, 30000, 25000, 20000, 15000, 10000, 7500, 5000, 4000, 3000, 2000, 1000, 500, 400, 300, 200, 100, 0]
                 errors: [1.4088, 1.3361, 1.2395, 1.1379, 1.0505, 0.98154, 0.92451, 0.87349, 0.82829, 0.79582, 0.77562, 0.75911, 0.7408, 0.72571, 0.72719, 0.75204, 0.80129, 0.8696, 0.93292, 0.9672, 0.9831, 0.99132, 0.99603, 0.99854, 0.99963, 0.99997, 1.0, 0.99999, 0.99995, 0.99985, 0.99958, 0.99914, 0.99869]

         # Error inflation based on pressure check (setupt.f90)
         - filter: Perform Action
           filter variables:
           - name: airTemperature
           where:
           - variable: ObsType/airTemperature
             is_in: 133
           action:
             name: inflate error
             inflation variable:
               name: ObsFunction/ObsErrorFactorPressureCheck
               options:
                 variable: airTemperature
                 inflation factor: 8.0

#         # Error inflation based on errormod (qcmod.f90)
#         - filter: Perform Action
#           filter variables:
#           - name: airTemperature
#           where:
#           - variable: ObsType/airTemperature
#             is_in: 133
#           action:
#             name: inflate error
#             inflation variable:
#               name: ObsFunction/ObsErrorFactorConventional
#               options:
#                 inflate variables: [airTemperature]
#                 pressure: MetaData/pressure

         # Error inflation when QualityMarker == 3 (read_prepbufr.f90)
         - filter: Perform Action
           filter variables:
           - name: airTemperature
           action:
             name: inflate error
             inflation factor: 1.2
           where:
           - variable: QualityMarker/airTemperature
             is_in: 3

         # Error inflation when observation pressure < 100 hPa (read_prepbufr.f90)
         - filter: Perform Action
           filter variables:
           - name: airTemperature
           action:
             name: inflate error
             inflation factor: 1.2
           where:
           - variable: MetaData/pressure
             maxvalue: 10000.0

         # Bounds Check (ObsError)
         - filter: Bounds Check
           filter variables:
           - name: airTemperature
           test variables:
           - name:  ObsErrorData/airTemperature
           minvalue: 0.0
           action:
             name: reduce obs space

         # Bounds Check (ObsValue)
         - filter: Bounds Check
           filter variables:
           - name: airTemperature
           minvalue: 100
           maxvalue: 400
           action:
             name: reduce obs space

         # Create temporary ObsErrorData
         - filter: Variable Assignment
           apply at iterations: 0,1
           assignments:
           - name: TempObsErrorData/airTemperature
             type: float
             function:
               name: ObsFunction/Arithmetic
               options:
                 variables:
                 - name: ObsErrorData/airTemperature
           defer to post: true

         # Set ObsError set "error parameter" if < "max value"
         - filter: Perform Action
           apply at iterations: 0,1
           filter variables:
           - name: airTemperature
           action:
             name: assign error
             error parameter: 1.3
           where:
           - variable:
               name: ObsErrorData/airTemperature
             maxvalue: 1.3
           - variable:
               name: ObsErrorData/airTemperature
             value: is_valid
           defer to post: true

         # Set ObsError set "error parameter" if > "min value"
         - filter: Perform Action
           apply at iterations: 0,1
           filter variables:
           - name: airTemperature
           action:
             name: assign error
             error parameter: 5.6
           where:
           - variable:
               name: ObsErrorData/airTemperature
             minvalue: 5.6
           - variable:
               name: ObsErrorData/airTemperature
             value: is_valid
           defer to post: true

         # Gross Error Check
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: airTemperature
           threshold: 7.0
           action:
             name: reject
           where:
           - variable: ObsType/airTemperature
           - variable: QualityMarker/airTemperature
             is_not_in: 3
           defer to post: true

         # Gross Error Check: cgross*0.7 if QualityMarker=3
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: airTemperature
           threshold: 4.9
           action:
             name: reject
           where:
           - variable: ObsType/airTemperature
           - variable: QualityMarker/airTemperature
             is_in: 3
           defer to post: true

         # Re-assign err ObsErrorData <--- TempObsErrorData after gross error check.
         - filter: Perform Action
           apply at iterations: 0,1
           filter variables:
           - name: airTemperature
           action:
             name: assign error
             error function: TempObsErrorData/airTemperature
           where:
           - variable:
               name: TempObsErrorData/airTemperature
             value: is_valid
           defer to post: true

         #- filter: GOMsaver
         #  filename: ./data/geovals/aircar_geovals_rrfs.nc4
     - obs space:
         name: aircar_q133
         distribution:
           name: "RoundRobin"
           halo size: 500e3
         obsdatain:
           engine:
             type: H5File
             obsfile: data/obs/ioda_aircar.nc
             missing file action: "warn"
           obsgrouping:
             group variables: ["stationIdentification"]
             sort variable: "pressure"
             sort order: "descending"
         obsdataout:
           engine:
             type: H5File
             obsfile: jdiag_aircar_q133.nc
             allow overwrite: true
         io pool:
           max pool size: 1
         observed variables: [specificHumidity]
         simulated variables: [specificHumidity]

       obs operator:
           name: VertInterp
           vertical coordinate: air_pressure
           observation vertical coordinate: pressure
           observation vertical coordinate group: MetaData
           interpolation method: log-linear
           #gsi geovals:
           #  filename: "obsout/aircraft_q_geoval_2022052619.nc4"
           #  levels_are_top_down: False
           variables:
           - name: specificHumidity

       linear obs operator:
         name: VertInterp

       obs error:
         covariance model: diagonal

       obs localizations:
         - localization method: Horizontal Gaspari-Cohn
           lengthscale: 200e3 # orig

       obs filters:
         # ------------------
         # specificHumidity (133)
         # ------------------
         # Reject all obs with QualityMarker > 3
         - filter: RejectList
           apply at iterations: 0,1
           filter variables:
           - name: specificHumidity
           where:
           - variable: QualityMarker/specificHumidity
             is_in: 4-15
             value: is_not_valid
           where operator: or
           action:
             name: reduce obs space

         # Time window filter
         - filter: Domain Check
           apply at iterations: 0,1
           where:
             - variable:
                 name: MetaData/timeOffset # units: s
               minvalue: -5400
               maxvalue:  5400
           action:
             name: reduce obs space

         # Duplicate Check
#         - filter: Temporal Thinning
#           apply at iterations: 0,1
#           filter variables:
#           - name: specificHumidity
#           min_spacing: PT90M
#           tolerance: PT0H
#           seed_time: "2024050600"
#           category_variable:
#             name: MetaData/longitude_latitude_pressure
#           action:
#             name: reduce obs space

         # Online regional domain check
         - filter: Bounds Check
           filter variables:
           - name: specificHumidity
           test variables:
           - name:  GeoVaLs/observable_domain_mask
           minvalue: 0.0
           maxvalue: 0.5

         # Initial error assignment
         - filter: Perform Action
           filter variables:
           - name: specificHumidity
           where:
           - variable: ObsType/specificHumidity
             is_in: 133
           action:
             name: assign error
             error function:
               name: ObsFunction/ObsErrorModelStepwiseLinear
               options:
                 xvar:
                   name: MetaData/pressure
                 xvals: [110000, 105000, 100000, 95000, 90000, 85000, 80000, 75000, 70000, 65000, 60000, 55000, 50000, 45000, 40000, 35000, 30000, 25000, 20000, 15000, 10000, 7500, 5000, 4000, 3000, 2000, 1000, 500, 400, 300, 200, 100, 0]
                 errors: [0.19455, 0.19064, 0.18488, 0.17877, 0.17342, 0.16976, 0.16777, 0.16696, 0.16605, 0.16522, 0.16637, 0.17086, 0.17791, 0.18492, 0.18996, 0.19294, 0.19447, 0.19597, 0.19748, 0.19866, 0.19941, 0.19979, 0.19994, 0.19999, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2]

         # Error inflation based on pressure check (setupq.f90)
         - filter: Perform Action
           filter variables:
           - name: specificHumidity
           where:
           - variable: ObsType/specificHumidity
             is_in: 133
           action:
             name: inflate error
             inflation variable:
               name: ObsFunction/ObsErrorFactorPressureCheck
               options:
                 variable: specificHumidity
                 inflation factor: 8.0
                 request_saturation_specific_humidity_geovals: false

#         # Error inflation based on errormod (qcmod.f90)
#         - filter: Perform Action
#           filter variables:
#           - name: specificHumidity
#           where:
#           - variable: ObsType/specificHumidity
#             is_in: 133
#           action:
#             name: inflate error
#             inflation variable:
#               name: ObsFunction/ObsErrorFactorConventional
#               options:
#                 inflate variables: [specificHumidity]
#                 pressure: MetaData/pressure

         # Error inflation when QualityMarker == 3 (read_prepbufr.f90)
         - filter: Perform Action
           filter variables:
           - name: specificHumidity
           action:
             name: inflate error
             inflation factor: 1.2
           where:
           - variable: QualityMarker/specificHumidity
             is_in: 3

         # Error inflation when observation pressure < 100 hPa (read_prepbufr.f90)
         - filter: Perform Action
           filter variables:
           - name: specificHumidity
           action:
             name: inflate error
             inflation factor: 1.2
           where:
           - variable: MetaData/pressure
             maxvalue: 10000.0

         # Bounds Check (ObsError)
         - filter: Bounds Check
           filter variables:
           - name: specificHumidity
           test variables:
           - name:  ObsErrorData/specificHumidity
           minvalue: 0.0
           action:
             name: reduce obs space

         # Bounds Check (ObsValue)
         - filter: Bounds Check
           filter variables:
           - name: specificHumidity
           minvalue: 0.0
           maxvalue: 1.0
           action:
             name: reduce obs space

         # Create temporary ObsErrorData
         - filter: Variable Assignment
           apply at iterations: 0,1
           assignments:
           - name: TempObsErrorData/specificHumidity
             type: float
             function:
               name: ObsFunction/Arithmetic
               options:
                 variables:
                 - name: ObsErrorData/specificHumidity
           defer to post: true

         # Set ObsError set "error parameter" if < "max value"
         - filter: Perform Action
           apply at iterations: 0,1
           filter variables:
           - name: specificHumidity
           action:
             name: assign error
             error parameter: 5.0
           where:
           - variable:
               name: ObsErrorData/specificHumidity
             maxvalue: 5.0
           - variable:
               name: ObsErrorData/specificHumidity
             value: is_valid
           defer to post: true

         # Set ObsError set "error parameter" if > "min value"
         - filter: Perform Action
           apply at iterations: 0,1
           filter variables:
           - name: specificHumidity
           action:
             name: assign error
             error parameter: 50.0
           where:
           - variable:
               name: ObsErrorData/specificHumidity
             minvalue: 50.0
           - variable:
               name: ObsErrorData/specificHumidity
             value: is_valid
           defer to post: true

         # Gross Error Check
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: specificHumidity
           threshold: 7.0
           action:
             name: reject
           where:
           - variable: ObsType/specificHumidity
           - variable: QualityMarker/specificHumidity
             is_not_in: 3
           defer to post: true

         # Gross Error Check: cgross*0.7 if QualityMarker=3
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: specificHumidity
           threshold: 4.9
           action:
             name: reject
           where:
           - variable: ObsType/specificHumidity
           - variable: QualityMarker/specificHumidity
             is_in: 3
           defer to post: true

         # Re-assign err ObsErrorData <--- TempObsErrorData after gross error check.
         - filter: Perform Action
           apply at iterations: 0,1
           filter variables:
           - name: specificHumidity
           action:
             name: assign error
             error function: TempObsErrorData/specificHumidity
           where:
           - variable:
               name: TempObsErrorData/specificHumidity
             value: is_valid
           defer to post: true

         #- filter: GOMsaver
         #  filename: ./data/geovals/aircar_geovals_rrfs.nc4
     - obs space:
         name: aircar_uv233
         distribution:
           name: "RoundRobin"
           halo size: 500e3
         obsdatain:
           engine:
             type: H5File
             obsfile: data/obs/ioda_aircar.nc
             missing file action: "warn"
           obsgrouping:
             group variables: ["stationIdentification"]
             sort variable: "pressure"
             sort order: "descending"
         obsdataout:
           engine:
             type: H5File
             obsfile: jdiag_aircar_uv233.nc
             allow overwrite: true
         io pool:
           max pool size: 1
         observed variables: [windEastward, windNorthward]
         simulated variables: [windEastward, windNorthward]

       obs operator:
           name: VertInterp
           vertical coordinate: air_pressure
           observation vertical coordinate: pressure
           observation vertical coordinate group: MetaData
           interpolation method: log-linear
           #gsi geovals:
           #  filename: "obsout/aircraft_uv_geoval_2022052619.nc4"
           #  levels_are_top_down: False
           variables:
           - name: windEastward
           - name: windNorthward

       linear obs operator:
         name: VertInterp

       obs error:
         covariance model: diagonal

       obs localizations:
         - localization method: Horizontal Gaspari-Cohn
           lengthscale: 200e3 # orig

       obs filters:
         # ------------------
         # wind (233)
         # ------------------
         # Reject all obs with QualityMarker > 3
         - filter: RejectList
           apply at iterations: 0,1
           filter variables:
           - name: windEastward
           - name: windNorthward
           where:
           - variable: QualityMarker/windEastward
             is_in: 4-15
             value: is_not_valid
           where operator: or
           action:
             name: reduce obs space

         # Time window filter
         - filter: Domain Check
           apply at iterations: 0,1
           where:
             - variable:
                 name: MetaData/timeOffset # units: s
               minvalue: -5400
               maxvalue:  5400
           action:
             name: reduce obs space

         # Duplicate Check
#         - filter: Temporal Thinning
#           apply at iterations: 0,1
#           filter variables:
#           - name: windEastward
#           - name: windNorthward
#           min_spacing: PT90M
#           tolerance: PT0H
#           seed_time: "2024050600"
#           category_variable:
#             name: MetaData/longitude_latitude_pressure
#           action:
#             name: reduce obs space

         # Online domain check
         - filter: Bounds Check
           filter variables:
           - name: windEastward
           - name: windNorthward
           test variables:
           - name:  GeoVaLs/observable_domain_mask
           minvalue: 0.0
           maxvalue: 0.5

         # Initial error assignment
         - filter: Perform Action
           filter variables:
           - name: windEastward
           - name: windNorthward
           where:
           - variable: ObsType/windEastward
             is_in: 233
           action:
             name: assign error
             error function:
               name: ObsFunction/ObsErrorModelStepwiseLinear
               options:
                 xvar:
                   name: MetaData/pressure
                 xvals: [110000, 105000, 100000, 95000, 90000, 85000, 80000, 75000, 70000, 65000, 60000, 55000, 50000, 45000, 40000, 35000, 30000, 25000, 20000, 15000, 10000, 7500, 5000, 4000, 3000, 2000, 1000, 500, 400, 300, 200, 100, 0]
                 errors: [2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214, 2.3214]

         # Error inflation (windEastward) based on pressure check (setupw.f90)
         - filter: Perform Action
           filter variables:
           - name: windEastward
           where:
           - variable: ObsType/windEastward
             is_in: 233
           action:
             name: inflate error
             inflation variable:
               name: ObsFunction/ObsErrorFactorPressureCheck
               options:
                 variable: windEastward
                 inflation factor: 4.0

         # Error inflation (windNorthward) based on pressure check (setupw.f90)
         - filter: Perform Action
           filter variables:
           - name: windNorthward
           where:
           - variable: ObsType/windNorthward
             is_in: 233
           action:
             name: inflate error
             inflation variable:
               name: ObsFunction/ObsErrorFactorPressureCheck
               options:
                 variable: windNorthward
                 inflation factor: 4.0

#         # Error inflation (windEastward) based on errormod (qcmod.f90)
#         - filter: Perform Action
#           filter variables:
#           - name: windEastward
#           where:
#           - variable: ObsType/windEastward
#             is_in: 233
#           action:
#             name: inflate error
#             inflation variable:
#               name: ObsFunction/ObsErrorFactorConventional
#               options:
#                 inflate variables: [windEastward]
#                 test QCflag: QualityMarker
#                 test QCthreshold: 3
#                 distance threshold: 0
#                 pressure: MetaData/pressure

#         # Error inflation (windNorthward) based on errormod (qcmod.f90)
#         - filter: Perform Action
#           filter variables:
#           - name: windNorthward
#           where:
#           - variable: ObsType/windNorthward
#             is_in: 233
#           action:
#             name: inflate error
#             inflation variable:
#               name: ObsFunction/ObsErrorFactorConventional
#               options:
#                 inflate variables: [windNorthward]
#                 test QCflag: QualityMarker
#                 test QCthreshold: 3
#                 distance threshold: 0
#                 pressure: MetaData/pressure

         # Error inflation when QualityMarker == 3 (read_prepbufr.f90)
         - filter: Perform Action
           filter variables:
           - name: windEastward
           - name: windNorthward
           action:
             name: inflate error
             inflation factor: 1.2
           where:
           - variable: QualityMarker/windEastward
             is_in: 3

         # Error inflation when observation pressure < 50 hPa (read_prepbufr.f90)
         - filter: Perform Action
           filter variables:
           - name: windEastward
           - name: windNorthward
           action:
             name: inflate error
             inflation factor: 1.2
           where:
           - variable: MetaData/pressure
             maxvalue: 5000.0

         # Bounds Check (ObsError)
         - filter: Bounds Check
           filter variables:
           - name: windEastward
           - name: windNorthward
           test variables:
           - name:  ObsErrorData/windEastward
           minvalue: 0.0
           action:
             name: reduce obs space

         # Bounds Check (ObsValue)
         - filter: Bounds Check
           filter variables:
           - name: windEastward
           - name: windNorthward
           minvalue: -200
           maxvalue: 200
           action:
             name: reduce obs space

         # Gross Error Check (windEastward)
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: windEastward
           function absolute threshold:
           - name: ObsFunction/WindsSPDBCheck
             options:
               wndtype:    [ 233 ]
               cgross:     [ 7.5 ]
               error_min:  [ 1.4 ]
               error_max:  [ 6.1 ]
               variable: windEastward
           where:
           - variable: QualityMarker/windEastward
             is_not_in: 3
           action:
             name: reject
           defer to post: true

         # Gross Error Check (windNorthward)
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: windNorthward
           function absolute threshold:
           - name: ObsFunction/WindsSPDBCheck
             options:
               wndtype:    [ 233 ]
               cgross:     [ 7.5 ]
               error_min:  [ 1.4 ]
               error_max:  [ 6.1 ]
               variable: windNorthward
           where:
           - variable: QualityMarker/windNorthward
             is_not_in: 3
           action:
             name: reject
           defer to post: true

         # Gross Error Check (windEastward): cgross*0.7 if QualityMarker=3
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: windEastward
           function absolute threshold:
           - name: ObsFunction/WindsSPDBCheck
             options:
               wndtype:    [ 233 ]
               cgross:     [ 5.25 ]
               error_min:  [ 1.4 ]
               error_max:  [ 6.1 ]
               variable: windEastward
           where:
           - variable: QualityMarker/windEastward
             is_in: 3
           action:
             name: reject
           defer to post: true

         # Gross Error Check (windNorthward): cgross*0.7 if QualityMarker=3
         - filter: Background Check
           apply at iterations: 0,1
           filter variables:
           - name: windNorthward
           function absolute threshold:
           - name: ObsFunction/WindsSPDBCheck
             options:
               wndtype:    [ 233 ]
               cgross:     [ 5.25 ]
               error_min:  [ 1.4 ]
               error_max:  [ 6.1 ]
               variable: windNorthward
           where:
           - variable: QualityMarker/windNorthward
             is_in: 3
           action:
             name: reject
           defer to post: true

         #- filter: GOMsaver
         #  filename: ./data/geovals/aircar_geovals_rrfs.nc4
     - obs space:
         name: amsua_n19
         distribution:
           name: "RoundRobin"
           halo size: 500e3
         obsdatain:
           engine:
             type: H5File
             obsfile: data/obs/ioda_amsua_n19.nc
             missing file action: "warn"
         obsdataout:
           engine:
             type: H5File
             obsfile: jdiag_amsua_n19.nc
         simulated variables: [brightnessTemperature]
         observed variables: [brightnessTemperature]
         channels: &amsua_n19_channels 1-15
       obs operator:
         name: CRTM
         Absorbers: [H2O,O3]
         SurfaceWindGeoVars: uv
         Clouds: [Water, Ice]
         Cloud_Fraction: 1.0
         obs options:
           Sensor_ID: amsua_n19
           EndianType: little_endian
           CoefficientPath: data/crtm/
           IRVISlandCoeff: IGBP
         linear obs operator:
           Absorbers: [H2O, O3]
       obs localizations:
         - localization method: Horizontal Gaspari-Cohn
           lengthscale: 200e3 # orig
       obs bias:
         input file: data/obs/amsua_n19.satbias.nc
         output file: out_amsua_n19.satbias.nc
         variational bc:
           predictors:
           - name: constant
           - name: lapseRate
             order: 2
             tlapse: &amsua_n19_tlapse data/obs/amsua_n19.tlapse.txt
           - name: lapseRate
             tlapse: *amsua_n19_tlapse
           - name: emissivityJacobian
           - name: sensorScanAngle
             order: 4
           - name: sensorScanAngle
             order: 3
           - name: sensorScanAngle
             order: 2
           - name: sensorScanAngle
         covariance:
           minimal required obs number: 20
           variance range: [1.0e-6, 10.0]
           step size: 1.0e-4
           largest analysis variance: 10000.0
           prior:
             input file: data/obs/amsua_n19.satbias_cov.nc
             inflation:
               ratio: 1.1
               ratio for small dataset: 2.0
           output file: out_amsua_n19.satbias_cov.nc
       obs filters:
       - filter: BlackList
         filter variables:
         - name: brightnessTemperature
           channels: *amsua_n19_channels
         action:
           name: assign error
           error function:
             name: ObsFunction/ObsErrorModelRamp
             channels: *amsua_n19_channels
             options:
               channels: *amsua_n19_channels
               xvar:
                 name: ObsFunction/CLWRetSymmetricMW
                 options:
                   clwret_ch238: 1
                   clwret_ch314: 2
                   clwret_types: [ObsValue, HofX]
               x0:    [ 0.050,  0.030,  0.030,  0.020,  0.000,
                        0.100,  0.000,  0.000,  0.000,  0.000,
                        0.000,  0.000,  0.000,  0.000,  0.030]
               x1:    [ 0.600,  0.450,  0.400,  0.450,  1.000,
                        1.500,  0.000,  0.000,  0.000,  0.000,
                        0.000,  0.000,  0.000,  0.000,  0.200]
               err0:  [ 2.500,  2.200,  2.000,  0.550,  0.300,
                        0.230,  0.230,  0.250,  0.250,  0.350,
                        0.400,  0.550,  0.800,  3.000,  3.500]
               err1:  [20.000, 18.000, 12.000,  3.000,  0.500,
                        0.300,  0.230,  0.250,  0.250,  0.350,
                        0.400,  0.550,  0.800,  3.000, 18.000]
       #  CLW Retrieval Check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: 1-6, 15
         test variables:
         - name: ObsFunction/CLWRetMW
           options:
             clwret_ch238: 1
             clwret_ch314: 2
             clwret_types: [ObsValue]
         maxvalue: 999.0
         action:
           name: reject
       #  CLW Retrieval Check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: 1-6, 15
         test variables:
         - name: ObsFunction/CLWRetMW
           options:
             clwret_ch238: 1
             clwret_ch314: 2
             clwret_types: [HofX]
         maxvalue: 999.0
         action:
           name: reject
       #  Hydrometeor Check (cloud/precipitation affected chanels)
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *amsua_n19_channels
         test variables:
         - name: ObsFunction/HydrometeorCheckAMSUA
           channels: *amsua_n19_channels
           options:
             channels: *amsua_n19_channels
             obserr_clearsky: [ 2.500, 2.200, 2.000, 0.550, 0.300,
                                0.230, 0.230, 0.250, 0.250, 0.350,
                                0.400, 0.550, 0.800, 3.000, 3.500]
             clwret_function:
               name: ObsFunction/CLWRetMW
               options:
                 clwret_ch238: 1
                 clwret_ch314: 2
                 clwret_types: [ObsValue]
             obserr_function:
               name: ObsFunction/ObsErrorModelRamp
               channels: *amsua_n19_channels
               options:
                 channels: *amsua_n19_channels
                 xvar:
                   name: ObsFunction/CLWRetSymmetricMW
                   options:
                     clwret_ch238: 1
                     clwret_ch314: 2
                     clwret_types: [ObsValue, HofX]
                 x0:    [ 0.050,  0.030,  0.030,  0.020,  0.000,
                          0.100,  0.000,  0.000,  0.000,  0.000,
                          0.000,  0.000,  0.000,  0.000,  0.030]
                 x1:    [ 0.600,  0.450,  0.400,  0.450,  1.000,
                          1.500,  0.000,  0.000,  0.000,  0.000,
                          0.000,  0.000,  0.000,  0.000,  0.200]
                 err0:  [ 2.500,  2.200,  2.000,  0.550,  0.300,
                          0.230,  0.230,  0.250,  0.250,  0.350,
                          0.400,  0.550,  0.800,  3.000,  3.500]
                 err1:  [20.000, 18.000, 12.000,  3.000,  0.500,
                         0.300,  0.230,  0.250,  0.250,  0.350,
                         0.400,  0.550,  0.800,  3.000, 18.000]
         maxvalue: 0.0
         action:
           name: reject
       #  Topography check
       - filter: BlackList
         filter variables:
         - name: brightnessTemperature
           channels: *amsua_n19_channels
         action:
           name: inflate error
           inflation variable:
             name: ObsFunction/ObsErrorFactorTopoRad
             channels: *amsua_n19_channels
             options:
               sensor: amsua_n19
               channels: *amsua_n19_channels
       #  Transmittnace Top Check
       - filter: BlackList
         filter variables:
         - name: brightnessTemperature
           channels: *amsua_n19_channels
         action:
           name: inflate error
           inflation variable:
             name: ObsFunction/ObsErrorFactorTransmitTopRad
             channels: *amsua_n19_channels
             options:
               sensor: amsua_n19
               channels: *amsua_n19_channels
       #  Surface Jacobian check
       - filter: BlackList
         filter variables:
         - name: brightnessTemperature
           channels: *amsua_n19_channels
         action:
           name: inflate error
           inflation variable:
             name: ObsFunction/ObsErrorFactorSurfJacobianRad
             channels: *amsua_n19_channels
             options:
               sensor: amsua_n19
               channels: *amsua_n19_channels
               obserr_demisf: [0.010, 0.020, 0.015, 0.020, 0.200]
               obserr_dtempf: [0.500, 2.000, 1.000, 2.000, 4.500]
       #  Situation dependent Check
       - filter: BlackList
         filter variables:
         - name: brightnessTemperature
           channels: *amsua_n19_channels
         action:
           name: inflate error
           inflation variable:
             name: ObsFunction/ObsErrorFactorSituDependMW
             channels: *amsua_n19_channels
             options:
               sensor: amsua_n19
               channels: *amsua_n19_channels
               clwobs_function:
                 name: ObsFunction/CLWRetMW
                 options:
                   clwret_ch238: 1
                   clwret_ch314: 2
                   clwret_types: [ObsValue]
               clwbkg_function:
                 name: ObsFunction/CLWRetMW
                 options:
                   clwret_ch238: 1
                   clwret_ch314: 2
                   clwret_types: [HofX]
                   bias_application: HofX
               scatobs_function:
                 name: ObsFunction/SCATRetMW
                 options:
                   scatret_ch238: 1
                   scatret_ch314: 2
                   scatret_ch890: 15
                   scatret_types: [ObsValue]
                   bias_application: HofX
               clwmatchidx_function:
                 name: ObsFunction/CLWMatchIndexMW
                 channels: *amsua_n19_channels
                 options:
                   channels: *amsua_n19_channels
                   clwobs_function:
                     name: ObsFunction/CLWRetMW
                     options:
                       clwret_ch238: 1
                       clwret_ch314: 2
                       clwret_types: [ObsValue]
                   clwbkg_function:
                     name: ObsFunction/CLWRetMW
                     options:
                       clwret_ch238: 1
                       clwret_ch314: 2
                       clwret_types: [HofX]
                       bias_application: HofX
                   clwret_clearsky: [0.050, 0.030, 0.030, 0.020, 0.000,
                                     0.100, 0.000, 0.000, 0.000, 0.000,
                                     0.000, 0.000, 0.000, 0.000, 0.030]
               obserr_function:
                 name: ObsFunction/ObsErrorModelRamp
                 channels: *amsua_n19_channels
                 options:
                   channels: *amsua_n19_channels
                   xvar:
                     name: ObsFunction/CLWRetSymmetricMW
                     options:
                       clwret_ch238: 1
                       clwret_ch314: 2
                       clwret_types: [ObsValue, HofX]
                   x0:    [ 0.050,  0.030,  0.030,  0.020,  0.000,
                            0.100,  0.000,  0.000,  0.000,  0.000,
                            0.000,  0.000,  0.000,  0.000,  0.030]
                   x1:    [ 0.600,  0.450,  0.400,  0.450,  1.000,
                            1.500,  0.000,  0.000,  0.000,  0.000,
                            0.000,  0.000,  0.000,  0.000,  0.200]
                   err0:  [ 2.500,  2.200,  2.000,  0.550,  0.300,
                            0.230,  0.230,  0.250,  0.250,  0.350,
                            0.400,  0.550,  0.800,  3.000,  3.500]
                   err1:  [20.000, 18.000, 12.000,  3.000,  0.500,
                            0.300,  0.230,  0.250,  0.250,  0.350,
                            0.400,  0.550,  0.800,  3.000, 18.000]
               obserr_clearsky: [2.500, 2.200, 2.000, 0.550, 0.300,
                                  0.230, 0.230, 0.250, 0.250, 0.350,
                                  0.400, 0.550, 0.800, 3.000, 3.500]
       #  Gross check
       - filter: Background Check
         filter variables:
         - name: brightnessTemperature
           channels: *amsua_n19_channels
         function absolute threshold:
         - name: ObsFunction/ObsErrorBoundMW
           channels: *amsua_n19_channels
           options:
             sensor: amsua_n19
             channels: *amsua_n19_channels
             obserr_bound_latitude:
               name: ObsFunction/ObsErrorFactorLatRad
               options:
                 latitude_parameters: [25.0, 0.25, 0.04, 3.0]
             obserr_bound_transmittop:
               name: ObsFunction/ObsErrorFactorTransmitTopRad
               channels: *amsua_n19_channels
               options:
                 channels: *amsua_n19_channels
             obserr_bound_topo:
               name: ObsFunction/ObsErrorFactorTopoRad
               channels: *amsua_n19_channels
               options:
                 channels: *amsua_n19_channels
                 sensor: amsua_n19
             obserr_function:
               name: ObsFunction/ObsErrorModelRamp
               channels: *amsua_n19_channels
               options:
                 channels: *amsua_n19_channels
                 xvar:
                   name: ObsFunction/CLWRetSymmetricMW
                   options:
                     clwret_ch238: 1
                     clwret_ch314: 2
                     clwret_types: [ObsValue, HofX]
                     bias_application: HofX
                 x0:    [ 0.050,  0.030,  0.030,  0.020,  0.000,
                          0.100,  0.000,  0.000,  0.000,  0.000,
                          0.000,  0.000,  0.000,  0.000,  0.030]
                 x1:    [ 0.600,  0.450,  0.400,  0.450,  1.000,
                          1.500,  0.000,  0.000,  0.000,  0.000,
                          0.000,  0.000,  0.000,  0.000,  0.200]
                 err0:  [ 2.500,  2.200,  2.000,  0.550,  0.300,
                          0.230,  0.230,  0.250,  0.250,  0.350,
                          0.400,  0.550,  0.800,  3.000,  3.500]
                 err1:  [20.000, 18.000, 12.000,  3.000,  0.500,
                          0.300,  0.230,  0.250,  0.250,  0.350,
                          0.400,  0.550,  0.800,  3.000, 18.000]
             obserr_bound_max: [4.5, 4.5, 4.5, 2.5, 2.0,
                                2.0, 2.0, 2.0, 2.0, 2.0,
                                2.5, 3.5, 4.5, 4.5, 4.5]
         action:
           name: reject
       #  Inter-channel check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *amsua_n19_channels
         test variables:
         - name: ObsFunction/InterChannelConsistencyCheck
           channels: *amsua_n19_channels
           options:
             channels: *amsua_n19_channels
             sensor: amsua_n19
             use_flag: [ 1,  1,  1,  1,  1,
                         1, -1, -1,  1,  1,
                         1,  1,  1, -1,  1 ]
         maxvalue: 1.0e-12
         action:
           name: reject
       #  Useflag check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *amsua_n19_channels
         test variables:
         - name: ObsFunction/ChannelUseflagCheckRad
           channels: *amsua_n19_channels
           options:
             sensor: amsua_n19
             channels: *amsua_n19_channels
             use_flag: [ 1,  1,  1,  1,  1,
                         1, -1, -1,  1,  1,
                         1,  1,  1, -1,  1 ]
         minvalue: 1.0e-12
         action:
           name: reject
     - obs space:
         name: atms_npp
         distribution:
           name: "RoundRobin"
           halo size: 500e3
         obsdatain:
           engine:
             type: H5File
             obsfile: data/obs/ioda_atms_npp.nc
             missing file action: "warn"
         obsdataout:
           engine:
             type: H5File
             obsfile: jdiag_atms_npp.nc
         simulated variables: [brightnessTemperature]
         observed variables: [brightnessTemperature]
         channels: &atms_npp_channels 1-22
       obs operator:
           name: CRTM
           Absorbers: [H2O,O3,CO2]
           Clouds: [Water, Ice]
           Cloud_Fraction: 1.0
           Cloud_Seeding: true
           SurfaceWindGeoVars: uv
           obs options:
             Sensor_ID: atms_npp
             EndianType: little_endian
             CoefficientPath: data/crtm/
             IRVISlandCoeff: IGBP
           linear obs operator:
             Absorbers: [H2O, O3]
       obs localizations:
         - localization method: Horizontal Gaspari-Cohn
           lengthscale: 200e3 # orig

       obs bias:
         input file:  data/obs/atms_npp.satbias.nc
         output file: out_atms_npp.satbias.nc
         variational bc:
           predictors:
           - name: constant
           - name: lapseRate
             order: 2
             tlapse: &atms_npp_tlapse  data/obs/atms_npp.tlapse.txt
           - name: lapseRate
             tlapse: *atms_npp_tlapse
           - name: emissivityJacobian
           - name: sensorScanAngle
             order: 4
           - name: sensorScanAngle
             order: 3
           - name: sensorScanAngle
             order: 2
           - name: sensorScanAngle
         covariance:
           minimal required obs number: 20
           variance range: [1.0e-6, 10.0]
           step size: 1.0e-4
           largest analysis variance: 10000.0
           prior:
             input file: data/obs/atms_npp.satbias_cov.nc
             inflation:
               ratio: 1.1
               ratio for small dataset: 2.0
           output file: out_atms_npp.satbias_cov.nc

       obs pre filters:
       # Step 0-A: Create Diagnostic Flags
       - filter: Create Diagnostic Flags
         filter variables:
         - name: brightnessTemperature
           channels: *atms_npp_channels
         flags:
         - name: ScanEdgeRemoval
           initial value: false
           force reinitialization: false
         - name: Thinning
           initial value: false
           force reinitialization: false
         - name: CLWRetrievalCheck
           initial value: false
           force reinitialization: false
         - name: WindowChannelExtremeResidual
           initial value: false
           force reinitialization: false
         - name: HydrometeorCheck
           initial value: false
           force reinitialization: false
         - name: GrossCheck
           initial value: false
           force reinitialization: false
         - name: InterChannelConsistency
           initial value: false
           force reinitialization: false
         - name: UseflagCheck
           initial value: false
           force reinitialization: false

       obs post filters:
       # Step 0-B: Calculate derived variables
       # Calculate CLW retrieved from observation
       - filter: Variable Assignment
         assignments:
         - name: CLWRetFromObs@DerivedMetaData
           type: float
           function:
             name: CLWRetMW@ObsFunction
             options:
               clwret_ch238: 1
               clwret_ch314: 2
               clwret_types: [ObsValue]

       # Calculate CLW retrieved from observation
       - filter: Variable Assignment
         assignments:
         - name: CLWRetFromBkg@DerivedMetaData
           type: float
           function:
             name: CLWRetMW@ObsFunction
             options:
               clwret_ch238: 1
               clwret_ch314: 2
               clwret_types: [HofX]

       # Calculate symmetric retrieved CLW
       - filter: Variable Assignment
         assignments:
         - name: CLWRetSymmetric@DerivedMetaData
           type: float
           value: 1000.0

       - filter: Variable Assignment
         where:
         - variable:
             name: CLWRetFromObs@DerivedMetaData
           minvalue:   0.
           maxvalue: 999.
         - variable:
             name: CLWRetFromBkg@DerivedMetaData
           minvalue:   0.
           maxvalue: 999.
         where operator: and
         assignments:
         - name: CLWRetSymmetric@DerivedMetaData
           type: float
           function:
             name: Arithmetic@ObsFunction
             options:
               variables:
               - name: CLWRetFromObs@DerivedMetaData
               - name: CLWRetFromBkg@DerivedMetaData
               total coefficient: 0.5

       # Calculate scattering index from observation
       - filter: Variable Assignment
         assignments:
         - name: SIRetFromObs@DerivedMetaData
           type: float
           function:
             name: SCATRetMW@ObsFunction
             options:
               scatret_ch238: 1
               scatret_ch314: 2
               scatret_ch890: 16
               scatret_types: [ObsValue]

       # Calculate CLW obs/bkg match index
       - filter: Variable Assignment
         assignments:
         - name: CLWMatchIndex@DerivedMetaData
           channels: *atms_npp_channels
           type: float
           function:
             name: CLWMatchIndexMW@ObsFunction
             channels: *atms_npp_channels
             options:
               channels: *atms_npp_channels
               clwobs_function:
                 name: CLWRetFromObs@DerivedMetaData
               clwbkg_function:
                 name: CLWRetFromBkg@DerivedMetaData
               clwret_clearsky: [ 0.030,  0.030,  0.030,  0.020,  0.030,
                                  0.080,  0.150,  0.000,  0.000,  0.000,
                                  0.000,  0.000,  0.000,  0.000,  0.000,
                                  0.020,  0.030,  0.030,  0.030,  0.030,
                                  0.050,  0.100]

       # Calculate symmetric observation error
       - filter: Variable Assignment
         assignments:
         - name: InitialObsError@DerivedMetaData
           channels: *atms_npp_channels
           type: float
           function:
             name: ObsErrorModelRamp@ObsFunction
             channels: *atms_npp_channels
             options:
               channels: *atms_npp_channels
               xvar:
                 name: CLWRetSymmetric@DerivedMetaData
               x0:    [ 0.030,  0.030,  0.030,  0.020,  0.030,
                        0.080,  0.150,  0.000,  0.000,  0.000,
                        0.000,  0.000,  0.000,  0.000,  0.000,
                        0.020,  0.030,  0.030,  0.030,  0.030,
                        0.050,  0.100]
               x1:    [ 0.350,  0.380,  0.400,  0.450,  0.500,
                        1.000,  1.000,  0.000,  0.000,  0.000,
                        0.000,  0.000,  0.000,  0.000,  0.000,
                        0.350,  0.500,  0.500,  0.500,  0.500,
                        0.500,  0.500]
               err0:  [ 4.500,  4.500,  4.500,  2.500,  0.550,
                        0.300,  0.300,  0.400,  0.400,  0.400,
                        0.450,  0.450,  0.550,  0.800,  4.000,
                        4.000,  4.000,  3.500,  3.000,  3.000,
                        3.000,  3.000]
               err1:  [20.000, 25.000, 12.000,  7.000,  3.500,
                        3.000,  0.800,  0.400,  0.400,  0.400,
                        0.450,  0.450,  0.550,  0.800,  4.000,
                       19.000, 30.000, 25.000, 16.500, 12.000,
                        9.000,  6.500]

       # Calculate Innovation@DerivedMetaData
       - filter: Variable Assignment
         assignments:
         - name: Innovation@DerivedMetaData
           channels: *atms_npp_channels
           type: float
           function:
             name: ObsFunction/Arithmetic
             channels: *atms_npp_channels
             options:
               variables:
               - name: brightnessTemperature@ObsValue
                 channels: *atms_npp_channels
               - name: brightnessTemperature@HofX
                 channels: *atms_npp_channels
               coefs: [1, -1]

       - filter: Bounds Check
         filter variables:
         #- name: brightnessTemperature
         - name: HofX/brightnessTemperature
           channels: *atms_npp_channels
         minvalue: 50.00001
         maxvalue: 449.99999
         action:
           name: reject

       # Regional Domain Check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *atms_npp_channels
         test variables:
         - name: GeoVaLs/observable_domain_mask
           flag all filter variables if any test variable is out of bounds: true
           minvalue: 0.0
           maxvalue: 0.5

       # Step 0-C: Assign Initial All-Sky Observation Error
       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: *atms_npp_channels
         action:
           name: assign error
           error function:
             name: InitialObsError@DerivedMetaData
             channels: *atms_npp_channels

       # Step 1: Remove Observations from the Edge of the Scan
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: 1-22
         where:
         - variable:
             name: MetaData/sensorScanPosition
           is_in: 7-90
         actions:
           - name: set
             flag: ScanEdgeRemoval
           - name: reject

       # Step 2: data Thinning
       - filter: Gaussian Thinning
         #horizontal_mesh: 145
         horizontal_mesh: 60
         use_reduced_horizontal_grid: true
         distance_norm: geodesic
       #  round_horizontal_bin_count_to_nearest: true
       #  partition_longitude_bins_using_mesh: true
         actions:
           - name: set
             flag: Thinning
           - name: reject

       # Step 3A: CLW Retrieval Check (observation_based)
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: 1-7, 16-22
         test variables:
         - name: CLWRetFromObs@DerivedMetaData
         maxvalue: 999.0
         actions:
           - name: set
             flag: CLWRetrievalCheck
           - name: reject

       # Step 3B: CLW Retrieval Check (background_based)
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: 1-7, 16-22
         test variables:
         - name: CLWRetFromBkg@DerivedMetaData
         maxvalue: 999.0
         actions:
           - name: set
             flag: CLWRetrievalCheck
           - name: reject

       # Step 4: Window Channel Sanity Check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: 1-7, 16, 17-22
         test variables:
         - name: Innovation@DerivedMetaData
           channels: 1, 2, 5-7, 16
         maxvalue: 200.0
         minvalue: -200.0
         flag all filter variables if any test variable is out of bounds: true
         actions:
           - name: set
             flag: WindowChannelExtremeResidual
           - name: reject

       # Step 5: Hydrometeor Check (cloud/precipitation affected chanels)
       - filter: Variable Assignment
         assignments:
         - name: DerivedMetaData/HydrometeorCheckATMS
           channels: *atms_npp_channels
           type: float
           function:
             name: HydrometeorCheckATMS@ObsFunction
             channels: *atms_npp_channels
             options:
               channels: *atms_npp_channels
               obserr_clearsky:  [ 4.500,  4.500,  4.500,  2.500,  0.550,
                                   0.300,  0.300,  0.400,  0.400,  0.400,
                                   0.450,  0.450,  0.550,  0.800,  4.000,
                                   4.000,  4.000,  3.500,  3.000,  3.000,
                                   3.000,  3.000]
               clwret_function:
                 name: CLWRetFromObs@DerivedMetaData
               obserr_function:
                 name: InitialObsError@DerivedMetaData
                 channels: *atms_npp_channels

       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *atms_npp_channels
         test variables:
         - name: DerivedMetaData/HydrometeorCheckATMS
           channels: *atms_npp_channels
         maxvalue: 0.0
         actions:
           - name: set
             flag: HydrometeorCheck
             ignore: rejected observations
           - name: reject

       # Step 6: Observation Error Inflation based on Topography Check
       - filter: Variable Assignment
         assignments:
         - name: ObsErrorFactorTopo@DerivedMetaData
           channels: *atms_npp_channels
           type: float
           function:
             name: ObsErrorFactorTopoRad@ObsFunction
             channels: *atms_npp_channels
             options:
               sensor: atms_npp
               channels: *atms_npp_channels

       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: *atms_npp_channels
         action:
           name: inflate error
           inflation variable:
             name: ObsErrorFactorTopo@DerivedMetaData
             channels: *atms_npp_channels

       # Step 7: Obs Error Inflation based on TOA Transmittancec Check
       - filter: Variable Assignment
         assignments:
         - name: ObsErrorFactorTransmitTop@DerivedMetaData
           channels: *atms_npp_channels
           type: float
           function:
             name: ObsErrorFactorTransmitTopRad@ObsFunction
             channels: *atms_npp_channels
             options:
               channels: *atms_npp_channels

       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: *atms_npp_channels
         action:
           name: inflate error
           inflation variable:
             name: ObsErrorFactorTransmitTop@DerivedMetaData
             channels: *atms_npp_channels

       # Step 8: Observation Error Inflation based on Surface Jacobian Check
       - filter: Variable Assignment
         assignments:
         - name: ObsErrorFactorSurfJacobian@DerivedMetaData
           channels: *atms_npp_channels
           type: float
           function:
             name: ObsErrorFactorSurfJacobianRad@ObsFunction
             channels: *atms_npp_channels
             options:
               sensor: atms_npp
               channels: *atms_npp_channels
               obserr_demisf: [0.010, 0.020, 0.015, 0.020, 0.200]
               obserr_dtempf: [0.500, 2.000, 1.000, 2.000, 4.500]

       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: *atms_npp_channels
         action:
           name: inflate error
           inflation variable:
             name: ObsErrorFactorSurfJacobian@DerivedMetaData
             channels: *atms_npp_channels

       # Step 9: Situation Dependent Check
       - filter: Variable Assignment
         assignments:
         - name: ObsErrorFactorSituDepend@DerivedMetaData
           channels: *atms_npp_channels
           type: float
           function:
             name: ObsErrorFactorSituDependMW@ObsFunction
             channels: *atms_npp_channels
             options:
               sensor: atms_npp
               channels: *atms_npp_channels
               clwbkg_function:
                 name: CLWRetFromBkg@DerivedMetaData
               clwobs_function:
                 name: CLWRetFromObs@DerivedMetaData
               scatobs_function:
                 name: SIRetFromObs@DerivedMetaData
               clwmatchidx_function:
                 name: CLWMatchIndex@DerivedMetaData
                 channels: *atms_npp_channels
               obserr_function:
                 name: InitialObsError@DerivedMetaData
                 channels: *atms_npp_channels
               obserr_clearsky:  [ 4.500,  4.500,  4.500,  2.500,  0.550,
                                   0.300,  0.300,  0.400,  0.400,  0.400,
                                   0.450,  0.450,  0.550,  0.800,  4.000,
                                   4.000,  4.000,  3.500,  3.000,  3.000,
                                   3.000,  3.000]

       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: *atms_npp_channels
         action:
           name: inflate error
           inflation variable:
             name: ObsErrorFactorSituDepend@DerivedMetaData
             channels: *atms_npp_channels

       # Step 10: Gross check
       # Remove data if abs(Obs-HofX) > absolute threhold
       - filter: Variable Assignment
         assignments:
         - name: ObsErrorFactorLat@DerivedMetaData
           type: float
           function:
             name: ObsErrorFactorLatRad@ObsFunction
             options:
               latitude_parameters: [25.0, 0.25, 0.04, 3.0]

       - filter: Variable Assignment
         assignments:
         - name: ObsErrorBound@DerivedMetaData
           channels: *atms_npp_channels
           type: float
           function:
             name: ObsErrorBoundMW@ObsFunction
             channels: *atms_npp_channels
             options:
               sensor: atms_npp
               channels: *atms_npp_channels
               obserr_bound_latitude:
                 name: ObsErrorFactorLat@DerivedMetaData
               obserr_bound_transmittop:
                 name: ObsErrorFactorTransmitTop@DerivedMetaData
                 channels: *atms_npp_channels
                 options:
                   channels: *atms_npp_channels
               obserr_bound_topo:
                 name: ObsErrorFactorTopo@DerivedMetaData
                 channels: *atms_npp_channels
               obserr_function:
                 name: InitialObsError@DerivedMetaData
                 channels: *atms_npp_channels
                 threhold: 3
               obserr_bound_max: [4.5, 4.5, 3.0, 3.0, 1.0,
                                  1.0, 1.0, 1.0, 1.0, 1.0,
                                  1.0, 1.0, 1.0, 2.0, 4.5,
                                  4.5, 2.0, 2.0, 2.0, 2.0,
                                  2.0, 2.0]

       - filter: Background Check
         filter variables:
         - name: brightnessTemperature
           channels: *atms_npp_channels
         function absolute threshold:
         - name: ObsErrorBound@DerivedMetaData
           channels: *atms_npp_channels
         actions:
           - name: set
             flag: GrossCheck
             ignore: rejected observations
           - name: reject

       # Step 11: Inter-Channel Check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *atms_npp_channels
         test variables:
         - name: InterChannelConsistencyCheck@ObsFunction
           channels: *atms_npp_channels
           options:
             channels: *atms_npp_channels
             use passive_bc: true
             sensor: atms_npp
             use_flag: [ 1,  1,  1,  1,  1,
                         1,  1,  1,  1,  1,
                         1,  1,  1, -1, -1,
                         1,  1,  1,  1,  1,
                         1,  1]
         maxvalue: 1.0e-12
         actions:
           - name: set
             flag: InterChannelConsistency
             ignore: rejected observations
           - name: reject

       # Step 12: Useflag Check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *atms_npp_channels
         test variables:
         - name: ObsFunction/ChannelUseflagCheckRad
           channels: *atms_npp_channels
           options:
             channels: *atms_npp_channels
             use_flag: [ 1,  1,  1,  1,  1,
                         1,  1,  1,  1,  1,
                         1,  1,  1, -1, -1,
                         1,  1,  1,  1,  1,
                         1,  1]
         minvalue: 1.0e-12
         actions:
           - name: set
             flag: UseflagCheck
             ignore: rejected observations
           - name: reject
  # Observation Space (I/O)
  # -----------------------
     - obs space:
         name: abi_g16
         distribution:
           name: "RoundRobin"
           halo size: 500e3
         obsdatain:
           engine:
             type: H5File
             obsfile: data/obs/ioda_abi_g16.nc
             missing file action: "warn"
         obsdataout:
           engine:
             type: H5File
             obsfile: jdiag_abi_g16.nc
         io pool:
           max pool size: 1
         simulated variables: [brightnessTemperature]
         observed variables: [brightnessTemperature]
         channels: &abi_g16_channels 7-16

  # Observation Operator
  # --------------------
       obs operator:
         name: CRTM
         Absorbers: [H2O, O3, CO2]
         #Clouds: [Water, Ice]
         #Cloud_Fraction: 1.0
         SurfaceWindGeoVars: uv
         obs options:
           Sensor_ID:  abi_g16
           EndianType: little_endian
           CoefficientPath: data/crtm/
           IRVISlandCoeff: IGBP
         linear obs operator:
           Absorbers: [H2O, O3]
       obs localizations:
         - localization method: Horizontal Gaspari-Cohn
           lengthscale: 200e3 # orig
  # Observation Bias Correction (VarBC)
  # -----------------------------------
       obs bias:
         input file: data/obs/abi_g16.satbias.nc
         output file: out_abi_g16.satbias.nc
         variational bc:
           predictors:
           - name: constant
           - name: lapseRate
             order: 2
             tlapse: &abi_g16_tlapse data/obs/abi_g16.tlapse.txt
           - name: lapseRate
             tlapse: *abi_g16_tlapse
           - name: emissivityJacobian
           - name: sensorScanAngle
             var_name: sensorScanPosition
             order: 4
           - name: sensorScanAngle
             var_name: sensorScanPosition
             order: 3
           - name: sensorScanAngle
             var_name: sensorScanPosition
             order: 2
           - name: sensorScanAngle
             var_name: sensorScanPosition
         covariance:
           minimal required obs number: 20
           variance range: [1.0e-6, 10.0]
           step size: 1.0e-4
           largest analysis variance: 10000.0
           prior:
             input file: data/obs/abi_g16.satbias_cov.nc
             inflation:
               ratio: 1.1
               ratio for small dataset: 2.0
           output file: out_abi_g16.satbias_cov.nc

  # Observation Filters (QC)
  # ------------------------
       obs prior filters:
       # Initial obs error assignment
       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         action:
           name: assign error
           error parameter vector: [ 2.2, 1.756, 1.587, 1.185, 2.2, 2.2, 2.2, 2.2, 2.2, 2.2 ]

       # Surface flag assignment from geoval
       - filter: Variable Assignment
         assignments:
         - name: DerivedMetaData/surfaceFlag
           type: int
           function:
             name: IntObsFunction/Conditional
             options:
               defaultvalue: 4
               firstmatchingcase: true
               cases:
               - where:
                 - variable:
                     name: GeoVaLs/water_area_fraction
                   minvalue: 0.99
                 value: 0
               - where:
                 - variable:
                     name: GeoVaLs/land_area_fraction
                   minvalue: 0.99
                 value: 1
               - where:
                 - variable:
                     name: GeoVaLs/ice_area_fraction
                   minvalue: 0.99
                 value: 2
               - where:
                 - variable:
                     name: GeoVaLs/surface_snow_area_fraction
                   minvalue: 0.99
                 value: 3

       # Surface Parameter assignment from geovals
       - filter: Variable Assignment
         assignments:
         - name: DerivedMetaData/surfaceParam
           type: int
           function:
             name: IntObsFunction/Conditional
             options:
               defaultvalue: 0
               firstmatchingcase: true
               cases:
               - where:
                 - variable:
                     name: GeoVaLs/water_area_fraction
                   minvalue: 0.99
                 value: 30
               - where:
                 - variable:
                     name: GeoVaLs/land_area_fraction
                   minvalue: 0.99
                 value: 15
               - where:
                 - variable:
                     name: GeoVaLs/ice_area_fraction
                   minvalue: 0.99
                 value: 20
               - where:
                 - variable:
                     name: GeoVaLs/surface_snow_area_fraction
                   minvalue: 0.99
                 value: 15

       # Criteria assignment for Thinning
       - filter: Variable Assignment
         assignments:
         - name: DerivedMetaData/thinningCriteria
           type: int
           function:
             name: IntObsFunction/Arithmetic
             options:
               variables:
               - name: DerivedMetaData/surfaceParam
               coefs: [1]

       # Thinning
       - filter: Gaussian Thinning
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         horizontal_mesh: 60
         use_reduced_horizontal_grid: true
         distance_norm: maximum
         time_mesh: 'PT06H'
         time_min: '2024-05-26T22:30:00Z'
         time_max: '2024-05-27T01:30:00Z'
         priority_variable: DerivedMetaData/thinningCriteria
         action:
           name: reject

       obs post filters:
       # Regional domain check to remove data outside of model domain
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         test variables:
         - name: GeoVaLs/observable_domain_mask
           flag all filter variables if any test variable is out of bounds: true
           minvalue: 0.0
           maxvalue: 0.5

       # Satellite Zenith Angle Check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         test variables:
         - name: MetaData/sensorZenithAngle
         maxvalue: 65.
         action:
           name: reject

       # from read_abi: Reject when cloud fraction is more than 30
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         where:
         - variable:
             name: MetaData/cloudAmount
             channels: 8
           maxvalue: 30.

       # from read_abi: WV Channels 8-10 scene consistency check SDTB>1.3
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature
             channels: 8-10
           maxvalue: 1.3
           max_exclusive: true

       # Surface type check
       # Toss channels 7, 11-16 over land
       - filter: RejectList
         filter variables:
         - name: brightnessTemperature
           channels: 7, 11-16
         where:
         - variable:
             name: GeoVaLs/land_area_fraction
           minvalue: 0.99

       # Toss all channels data over snow
       - filter: RejectList
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         where:
         - variable:
             name: GeoVaLs/surface_snow_area_fraction
           minvalue: 0.99

       # Toss all channels data over ice
       - filter: RejectList
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         where:
         - variable:
             name: GeoVaLs/ice_area_fraction
           minvalue: 0.99

       # Toss all channels data over mixed surface
       - filter: RejectList
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         where:
         - variable:
             name: GeoVaLs/land_area_fraction
           maxvalue: 0.99
           max_exclusive: true
         - variable:
             name: GeoVaLs/water_area_fraction
           maxvalue: 0.99
           max_exclusive: true
         - variable:
             name: GeoVaLs/ice_area_fraction
           maxvalue: 0.99
           max_exclusive: true
         - variable:
             name: GeoVaLs/surface_snow_area_fraction
           maxvalue: 0.99
           max_exclusive: true

       # BT range check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         minvalue: 0.0
         maxvalue: 1000.0
         action:
           name: reject

       # Model top transmittance check
       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         action:
           name: inflate error
           inflation variable:
             name: ObsFunction/ObsErrorFactorTransmitTopRad
             channels: *abi_g16_channels
             options:
               channels: *abi_g16_channels

       # Cloud detection
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         test variables:
         - name: ObsFunction/CloudDetectMinResidualIR
           channels: *abi_g16_channels
           options:
             channels: *abi_g16_channels
             use_flag: [-1, 1, 1, 1, -1, -1, -1, -1, -1, -1]
             use_flag_clddet: [-2, -2, -2, -2, -2, -2, -2, -2, -2, -2]
             obserr_dtempf: [0.5, 2.0, 4.0, 2.0, 4.0]
             error parameter vector: [ 2.2, 1.756, 1.587, 1.185, 2.2, 2.2, 2.2, 2.2, 2.2, 2.2 ]
         maxvalue: 1.0e-12
         action:
           name: reject

       # Scene Consistency Check based on ch13 (10.8 micron)
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: 7, 10-16
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature
             channels: 13
           maxvalue: 0.5
           max_exclusive: true

       # Aadjust Channels 8-10 varinv according to ch8 BT standard deviation
       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: 8-10
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature_8
           maxvalue: 0.5
           minvalue: 0.4
           min_exclusive: true
         action:
           name: inflate error
           inflation factor: 1.1489

       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: 8-10
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature_8
           maxvalue: 0.6
           #max_exclusive: true
           minvalue: 0.5
           min_exclusive: true
         action:
           name: inflate error
           inflation factor: 1.2923

       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: 8-10
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature_8
           maxvalue: 0.7
           #max_exclusive: true
           minvalue: 0.6
           min_exclusive: true
         action:
           name: inflate error
           inflation factor: 1.4967

       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: 8-10
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature_8
           minvalue: 0.7
           min_exclusive: true
         action:
           name: inflate error
           inflation factor: 1.5199

       # Near SST Check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         test variables:
         - name: ObsFunction/NearSSTRetCheckIR
           channels: *abi_g16_channels
           options:
             channels: *abi_g16_channels
             use_flag: [-1, 1, 1, 1, -1, -1, -1, -1, -1, -1]
         maxvalue: 1.0e-12
         action:
           name: reject

       # Surface Jacobian
       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         action:
           name: inflate error
           inflation variable:
             name: ObsFunction/ObsErrorFactorSurfJacobianRad
             channels: *abi_g16_channels
             options:
               channels: *abi_g16_channels
               sensor: abi_g16
               obserr_demisf: [0.01, 0.02, 0.03, 0.02, 0.03]
               obserr_dtempf: [0.5, 2.0, 4.0, 2.0, 4.0]

       # Channels 7, 10-16 Cloud fraction >2
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: 7, 10-16
         where:
         - variable:
             name: MetaData/cloudAmount
           maxvalue: 2

       # Variable assignment, OmF non bias corrected
       - filter: Variable Assignment
         assignments:
         - name: OmFNBC@DerivedMetaData
           type: float
           function:
             name: ObsFunction/Arithmetic
             options:
               variables:
               - name: brightnessTemperature@ObsValue
                 channels: 13
               - name: brightnessTemperature@HofX
                 channels: 13
               - name: brightnessTemperature@ObsBiasData
                 channels: 13
               - name: brightnessTemperature@ObsValue
                 channels: 14
               - name: brightnessTemperature@HofX
                 channels: 14
               - name: brightnessTemperature@ObsBiasData
                 channels: 14
               coefs: [1, -1, 1, -1, 1, -1]

       # Use split window chns to remove opaque clouds
       # Toss Channels 7, 10-16, when OmFNBC < -0.75
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: 7, 10-16
         where:
         - variable:
             name: OmFNBC@DerivedMetaData
           minvalue: -0.75
           max_exclusive: true

       # Final gross check
       - filter: Background Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g16_channels
         function absolute threshold:
         - name: ObsFunction/ObsErrorBoundIR
           channels: *abi_g16_channels
           options:
             sensor: abi_g16
             channels: *abi_g16_channels
             obserr_bound_latitude:
               name: ObsFunction/ObsErrorFactorLatRad
               options:
                 latitude_parameters: [0.0, 0.0, 0.0, 0.0]
             obserr_bound_transmittop:
               name: ObsFunction/ObsErrorFactorTransmitTopRad
               channels: *abi_g16_channels
               options:
                 channels: *abi_g16_channels
             obserr_bound_max: [2.0, 2.0, 2.0, 2.0, 2.0, 2.0, 2.0, 2.0, 2.0, 2.0]
             error parameter vector: [ 2.2, 1.756, 1.587, 1.185, 2.2, 2.2, 2.2, 2.2, 2.2, 2.2 ]
         action:
           name: reject
  # Observation Space (I/O)
  # -----------------------
     - obs space:
         name: abi_g18
         distribution:
           name: "RoundRobin"
           halo size: 500e3
         obsdatain:
           engine:
             type: H5File
             obsfile: data/obs/ioda_abi_g18.nc
             missing file action: "warn"
         obsdataout:
           engine:
             type: H5File
             obsfile: jdiag_abi_g18.nc
         io pool:
           max pool size: 1
         simulated variables: [brightnessTemperature]
         observed variables: [brightnessTemperature]
         channels: &abi_g18_channels 7-16

  # Observation Operator
  # --------------------
       obs operator:
         name: CRTM
         Absorbers: [H2O, O3, CO2]
         #Clouds: [Water, Ice]
         #Cloud_Fraction: 1.0
         SurfaceWindGeoVars: uv
         obs options:
           Sensor_ID:  abi_g18
           EndianType: little_endian
           CoefficientPath: data/crtm/
           IRVISlandCoeff: IGBP
         linear obs operator:
           Absorbers: [H2O, O3]
       obs localizations:
         - localization method: Horizontal Gaspari-Cohn
           lengthscale: 200e3 # orig

  # Observation Bias Correction (VarBC)
  # -----------------------------------
       obs bias:
         input file: data/obs/abi_g18.satbias.nc
         output file: out_abi_g18.satbias.nc
         variational bc:
           predictors:
           - name: constant
           - name: lapseRate
             order: 2
             tlapse: &abi_g18_tlapse data/obs/abi_g18.tlapse.txt
           - name: lapseRate
             tlapse: *abi_g18_tlapse
           - name: emissivityJacobian
           - name: sensorScanAngle
             var_name: sensorScanPosition
             order: 4
           - name: sensorScanAngle
             var_name: sensorScanPosition
             order: 3
           - name: sensorScanAngle
             var_name: sensorScanPosition
             order: 2
           - name: sensorScanAngle
             var_name: sensorScanPosition
         covariance:
           minimal required obs number: 20
           variance range: [1.0e-6, 10.0]
           step size: 1.0e-4
           largest analysis variance: 10000.0
           prior:
             input file: data/obs/abi_g18.satbias_cov.nc
             inflation:
               ratio: 1.1
               ratio for small dataset: 2.0
           output file: out_abi_g18.satbias_cov.nc

  # Observation Filters (QC)
  # ------------------------
       obs prior filters:
       # Initial obs error assignment
       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g18_channels
         action:
           name: assign error
           error parameter vector: [ 2.2, 1.756, 1.587, 1.185, 2.2, 2.2, 2.2, 2.2, 2.2, 2.2 ]

       # Surface flag assignment from geoval
       - filter: Variable Assignment
         assignments:
         - name: DerivedMetaData/surfaceFlag
           type: int
           function:
             name: IntObsFunction/Conditional
             options:
               defaultvalue: 4
               firstmatchingcase: true
               cases:
               - where:
                 - variable:
                     name: GeoVaLs/water_area_fraction
                   minvalue: 0.99
                 value: 0
               - where:
                 - variable:
                     name: GeoVaLs/land_area_fraction
                   minvalue: 0.99
                 value: 1
               - where:
                 - variable:
                     name: GeoVaLs/ice_area_fraction
                   minvalue: 0.99
                 value: 2
               - where:
                 - variable:
                     name: GeoVaLs/surface_snow_area_fraction
                   minvalue: 0.99
                 value: 3

       # Surface Parameter assignment from geovals
       - filter: Variable Assignment
         assignments:
         - name: DerivedMetaData/surfaceParam
           type: int
           function:
             name: IntObsFunction/Conditional
             options:
               defaultvalue: 0
               firstmatchingcase: true
               cases:
               - where:
                 - variable:
                     name: GeoVaLs/water_area_fraction
                   minvalue: 0.99
                 value: 30
               - where:
                 - variable:
                     name: GeoVaLs/land_area_fraction
                   minvalue: 0.99
                 value: 15
               - where:
                 - variable:
                     name: GeoVaLs/ice_area_fraction
                   minvalue: 0.99
                 value: 20
               - where:
                 - variable:
                     name: GeoVaLs/surface_snow_area_fraction
                   minvalue: 0.99
                 value: 15

       # Criteria assignment for Thinning
       - filter: Variable Assignment
         assignments:
         - name: DerivedMetaData/thinningCriteria
           type: int
           function:
             name: IntObsFunction/Arithmetic
             options:
               variables:
               - name: DerivedMetaData/surfaceParam
               coefs: [1]

       # Thinning
       - filter: Gaussian Thinning
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g18_channels
         horizontal_mesh: 60
         use_reduced_horizontal_grid: true
         distance_norm: maximum
         time_mesh: 'PT06H'
         time_min: '2024-05-26T22:30:00Z'
         time_max: '2024-05-27T01:30:00Z'
         priority_variable: DerivedMetaData/thinningCriteria
         action:
           name: reject

       obs post filters:
       # Regional domain check to remove data outside of model domain
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g18_channels
         test variables:
         - name: GeoVaLs/observable_domain_mask
           flag all filter variables if any test variable is out of bounds: true
           minvalue: 0.0
           maxvalue: 0.5

       # Satellite Zenith Angle Check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g18_channels
         test variables:
         - name: MetaData/sensorZenithAngle
         maxvalue: 65.
         action:
           name: reject

       # from read_abi: Reject when cloud fraction is more than 30
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g18_channels
         where:
         - variable:
             name: MetaData/cloudAmount
             channels: 8
           maxvalue: 30.

       # from read_abi: WV Channels 8-10 scene consistency check SDTB>1.3
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g18_channels
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature
             channels: 8-10
           maxvalue: 1.3
           max_exclusive: true

       # Surface type check
       # Toss channels 7,11-16 over land
       - filter: RejectList
         filter variables:
         - name: brightnessTemperature
           channels: 7, 11-16
         where:
         - variable:
             name: GeoVaLs/land_area_fraction
           minvalue: 0.99

       # Toss all channels data over snow
       - filter: RejectList
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g18_channels
         where:
         - variable:
             name: GeoVaLs/surface_snow_area_fraction
           minvalue: 0.99

       # Toss all channels data over ice
       - filter: RejectList
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g18_channels
         where:
         - variable:
             name: GeoVaLs/ice_area_fraction
           minvalue: 0.99

       # Toss all channels data over mixed surface
       - filter: RejectList
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g18_channels
         where:
         - variable:
             name: GeoVaLs/land_area_fraction
           maxvalue: 0.99
           max_exclusive: true
         - variable:
             name: GeoVaLs/water_area_fraction
           maxvalue: 0.99
           max_exclusive: true
         - variable:
             name: GeoVaLs/ice_area_fraction
           maxvalue: 0.99
           max_exclusive: true
         - variable:
             name: GeoVaLs/surface_snow_area_fraction
           maxvalue: 0.99
           max_exclusive: true

       # BT range check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g18_channels
         minvalue: 0.0
         maxvalue: 1000.0
         action:
           name: reject

       # Model top transmittance check
       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g18_channels
         action:
           name: inflate error
           inflation variable:
             name: ObsFunction/ObsErrorFactorTransmitTopRad
             channels: *abi_g18_channels
             options:
               channels: *abi_g18_channels

       # Cloud detection
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g18_channels
         test variables:
         - name: ObsFunction/CloudDetectMinResidualIR
           channels: *abi_g18_channels
           options:
             channels: *abi_g18_channels
             use_flag: [-1, 1, 1, 1, -1, -1, -1, -1, -1, -1]
             use_flag_clddet: [-2, -2, -2, -2, -2, -2, -2, -2, -2, -2]
             obserr_dtempf: [0.5, 2.0, 4.0, 2.0, 4.0]
             error parameter vector: [ 2.2, 1.756, 1.587, 1.185, 2.2, 2.2, 2.2, 2.2, 2.2, 2.2 ]
         maxvalue: 1.0e-12
         action:
           name: reject

       # Scene Consistency Check based on ch13 (10.8 micron)
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: 7, 10-16
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature
             channels: 13
           maxvalue: 0.5
           max_exclusive: true

       # Aadjust Channels 8-10 varinv according to ch8 BT standard deviation
       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: 8-10
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature_8
           maxvalue: 0.5
           minvalue: 0.4
           min_exclusive: true
         action:
           name: inflate error
           inflation factor: 1.1489

       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: 8-10
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature_8
           maxvalue: 0.6
           #max_exclusive: true
           minvalue: 0.5
           min_exclusive: true
         action:
           name: inflate error
           inflation factor: 1.2923

       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: 8-10
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature_8
           maxvalue: 0.7
           #max_exclusive: true
           minvalue: 0.6
           min_exclusive: true
         action:
           name: inflate error
           inflation factor: 1.4967

       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: 8-10
         where:
         - variable:
             name: ClearSkyStdDev/brightnessTemperature_8
           minvalue: 0.7
           min_exclusive: true
         action:
           name: inflate error
           inflation factor: 1.5199

       # Near SST Check
       - filter: Bounds Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g18_channels
         test variables:
         - name: ObsFunction/NearSSTRetCheckIR
           channels: *abi_g18_channels
           options:
             channels: *abi_g18_channels
             use_flag: [-1, 1, 1, 1, -1, -1, -1, -1, -1, -1]
         maxvalue: 1.0e-12
         action:
           name: reject

       # Surface Jacobian
       - filter: Perform Action
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g18_channels
         action:
           name: inflate error
           inflation variable:
             name: ObsFunction/ObsErrorFactorSurfJacobianRad
             channels: *abi_g18_channels
             options:
               channels: *abi_g18_channels
               sensor: abi_g18
               obserr_demisf: [0.01, 0.02, 0.03, 0.02, 0.03]
               obserr_dtempf: [0.5, 2.0, 4.0, 2.0, 4.0]

       # Channels 7, 10-16 Cloud fraction >2
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: 7, 10-16
         where:
         - variable:
             name: MetaData/cloudAmount
           maxvalue: 2

       # Variable assignment, OmF non bias corrected
       - filter: Variable Assignment
         assignments:
         - name: OmFNBC@DerivedMetaData
           type: float
           function:
             name: ObsFunction/Arithmetic
             options:
               variables:
               - name: brightnessTemperature@ObsValue
                 channels: 13
               - name: brightnessTemperature@HofX
                 channels: 13
               - name: brightnessTemperature@ObsBiasData
                 channels: 13
               - name: brightnessTemperature@ObsValue
                 channels: 14
               - name: brightnessTemperature@HofX
                 channels: 14
               - name: brightnessTemperature@ObsBiasData
                 channels: 14
               coefs: [1, -1, 1, -1, 1, -1]

       # Toss Channels 7, 10-16, when OmFNBC < -0.75
       - filter: Domain Check
         filter variables:
         - name: brightnessTemperature
           channels: 7, 10-16
         where:
         - variable:
             name: OmFNBC@DerivedMetaData
           minvalue: -0.75
           max_exclusive: true

       # Final gross check
       - filter: Background Check
         filter variables:
         - name: brightnessTemperature
           channels: *abi_g18_channels
         function absolute threshold:
         - name: ObsFunction/ObsErrorBoundIR
           channels: *abi_g18_channels
           options:
             sensor: abi_g18
             channels: *abi_g18_channels
             obserr_bound_latitude:
               name: ObsFunction/ObsErrorFactorLatRad
               options:
                 latitude_parameters: [0.0, 0.0, 0.0, 0.0]
             obserr_bound_transmittop:
               name: ObsFunction/ObsErrorFactorTransmitTopRad
               channels: *abi_g18_channels
               options:
                 channels: *abi_g18_channels
             obserr_bound_max: [2.0, 2.0, 2.0, 2.0, 2.0, 2.0, 2.0, 2.0, 2.0, 2.0]
             error parameter vector: [ 2.2, 1.756, 1.587, 1.185, 2.2, 2.2, 2.2, 2.2, 2.2, 2.2 ]
         action:
           name: reject
